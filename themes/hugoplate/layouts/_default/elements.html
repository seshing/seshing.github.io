{{ define "main" }}
<div class="section">
  <div class="container">
    <div class="row justify-center">
      <div class="md:col-10 lg:col-8">
        <h1 class="mb-8 text-center text-h2">{{ .Title }}</h1>
        
        <!-- Filter Controls -->
        <div class="mb-8 flex flex-wrap gap-4 justify-center">
          <div class="flex gap-2 items-center">
            <label class="font-semibold">Sort by:</label>
            <select id="sortBy" class="w-62 border border-gray-300 dark:border-gray-600 rounded px-3 py-2 bg-white dark:bg-gray-800">
              <option value="year-desc">Year (Newest First)</option>
              <option value="year-asc">Year (Oldest First)</option>
              <option value="title">Title (A-Z)</option>
            </select>
          </div>
          <div class="flex gap-2 items-center">
            <label class="font-semibold">Filter:</label>
            <select id="filterBy" class="w-62 border border-gray-300 dark:border-gray-600 rounded px-3 py-2 bg-white dark:bg-gray-800">
              <option value="all">All Publications</option>
              <option value="first-author">First Author Only</option>
            </select>
          </div>
        </div>

        <!-- Publications List -->
        <div id="publicationsList">
          {{ $publications := .Params.publications }}
          {{ range $i, $pub := $publications }}
            {{ $citeID := printf "cite-box-%d" $i }}
            {{ $isFirstAuthor := false }}
            {{ with index $pub.authors 0 }}
              {{ if hasPrefix . "**Xiucheng Liang**" }}
                {{ $isFirstAuthor = true }}
              {{ end }}
            {{ end }}
            
            <div class="publication-item mb-8 p-6 border border-gray-200 dark:border-gray-700 rounded-lg bg-white dark:bg-neutral-900 {{ if $isFirstAuthor }}first-author{{ end }}" 
                 data-year="{{ $pub.year }}" 
                 data-title="{{ $pub.title }}" 
                 data-first-author="{{ $isFirstAuthor }}">
              
              <h3 class="text-xl font-semibold mb-2 text-gray-900 dark:text-gray-100 {{ if $isFirstAuthor }}text-primary{{ end }}">
                {{ $pub.title }}
              </h3>
              
              <p class="text-gray-700 dark:text-gray-300 mb-2">
                {{ range $idx, $author := $pub.authors }}
                  {{ if $idx }}, {{ end }}{{ $author | markdownify }}
                {{ end }}
              </p>
              
              <p class="text-gray-500 dark:text-gray-400 mb-4">{{ $pub.paper_info }}</p>
              
              <!-- Action Buttons -->
              <div class="flex flex-wrap gap-3 mb-4">
                {{ with $pub.pdf_link }}
                  <a href="{{ . }}" class="btn btn-primary btn-sm" target="_blank" rel="noopener">
                    PDF
                  </a>
                {{ end }}
                
                {{ with $pub.doi_link }}
                  <a href="{{ . }}" class="btn btn-secondary btn-sm" target="_blank" rel="noopener">
                    DOI
                  </a>
                {{ end }}
                
                {{ with $pub.code_link }}
                  <a href="{{ . }}" class="btn btn-secondary btn-sm" target="_blank" rel="noopener">
                    Code
                  </a>
                {{ end }}
                
                {{ with $pub.bibtex }}
                  <button class="btn btn-secondary btn-sm" data-toggle-cite="{{ $citeID }}">
                    BibTeX
                  </button>
                {{ end }}
              </div>
              
              <!-- Citation Box -->
              {{ with $pub.bibtex }}
                <div id="{{ $citeID }}" class="citation-box hidden mt-4 p-4 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-600 rounded">
                  <pre class="text-sm overflow-auto text-gray-800 dark:text-gray-200"><code data-cite-text>{{ . | safeHTML }}</code></pre>
                  <div class="mt-3 flex gap-2">
                    <button class="btn btn-primary btn-xs" data-copy-cite>
                      Copy
                    </button>
                    <button class="btn btn-secondary btn-xs" data-download-cite>
                      Download
                    </button>
                  </div>
                </div>
              {{ end }}
            </div>
          {{ end }}
        </div>

        <!-- Statistics -->
        <div class="mt-12 p-6 bg-gray-50 dark:bg-gray-800 rounded-lg text-center">
          <p class="text-gray-600 dark:text-gray-400">
            <span id="totalPubs">{{ len .Params.publications }}</span> total publications â€¢ 
            <span id="firstAuthorPubs">0</span> first-author publications
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  function getCiteText(btn) {
    const box = btn.closest('.publication-item').querySelector('.citation-box');
    const code = box && box.querySelector('code[data-cite-text]');
    return code ? code.textContent : '';
  }
  
  function updateStats() {
    const items = Array.from(document.querySelectorAll('.publication-item'));
    const visibleItems = items.filter(item => item.style.display !== 'none');
    const firstAuthorVisible = visibleItems.filter(item => item.dataset.firstAuthor === 'true');
    
    document.getElementById('totalPubs').textContent = visibleItems.length;
    document.getElementById('firstAuthorPubs').textContent = firstAuthorVisible.length;
  }
  
  function sortAndFilter() {
    const sortBy = document.getElementById('sortBy').value;
    const filterBy = document.getElementById('filterBy').value;
    const items = Array.from(document.querySelectorAll('.publication-item'));
    
    // Filter items
    items.forEach(item => {
      const isFirstAuthor = item.dataset.firstAuthor === 'true';
      if (filterBy === 'first-author' && !isFirstAuthor) {
        item.style.display = 'none';
      } else {
        item.style.display = 'block';
      }
    });
    
    // Sort visible items
    const visibleItems = items.filter(item => item.style.display !== 'none');
    
    visibleItems.sort((a, b) => {
      switch(sortBy) {
        case 'year-desc':
          return parseInt(b.dataset.year) - parseInt(a.dataset.year);
        case 'year-asc':
          return parseInt(a.dataset.year) - parseInt(b.dataset.year);
        case 'title':
          return a.dataset.title.localeCompare(b.dataset.title);
        default:
          return 0;
      }
    });
    
    // Reorder DOM elements
    const publicationsList = document.getElementById('publicationsList');
    visibleItems.forEach(item => publicationsList.appendChild(item));
    
    // Update statistics
    updateStats();
  }
  
  document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('sortBy').addEventListener('change', sortAndFilter);
    document.getElementById('filterBy').addEventListener('change', sortAndFilter);
    
    // Initial sort and stats
    sortAndFilter();
  });

  document.addEventListener('click', async (e) => {
    // Toggle cite box
    const toggle = e.target.closest('[data-toggle-cite]');
    if (toggle) {
      e.preventDefault();
      const box = document.getElementById(toggle.getAttribute('data-toggle-cite'));
      if (box) box.classList.toggle('hidden');
      return;
    }
    
    // Copy citation
    if (e.target.closest('[data-copy-cite]')) {
      const text = getCiteText(e.target).trim();
      try {
        await navigator.clipboard.writeText(text);
        e.target.textContent = 'Copied!';
        setTimeout(() => (e.target.textContent = 'Copy'), 1200);
      } catch (err) {
        console.error('Copy failed:', err);
      }
      return;
    }
    
    // Download citation
    if (e.target.closest('[data-download-cite]')) {
      const text = getCiteText(e.target).trim();
      const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'citation.bib';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      return;
    }
  });
})();
</script>

<style>
.btn-sm { 
  padding: 0.375rem 0.75rem; 
  font-size: 0.875rem; 
  line-height: 1.25rem;
}
.btn-xs { 
  padding: 0.25rem 0.5rem; 
  font-size: 0.75rem; 
  line-height: 1rem;
}
.first-author { 
  border-left: 4px solid #424242; /* Light mode color */
}
.dark .first-author {
  border-left: 4px solid #D6D6D6; /* Dark mode color (lighter green) */
}
.publication-item:hover { 
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  transform: translateY(-1px);
  transition: all 0.2s ease-in-out;
}
.citation-box pre {
  max-height: 300px;
  overflow-y: auto;
}
select {
  transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}
select:focus {
  outline: none;
  border-color: var(--color-primary, #3b82f6);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}
</style>
{{ end }}
