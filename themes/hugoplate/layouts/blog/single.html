{{ define "main" }}
  <section class="section pt-7">
    <div class="container">
      <div class="row justify-center">
        <article class="lg:col-10">
          {{ $image:= .Params.image }}
          {{ if $image }}
            <div class="mb-10">
              {{ partial "image" (dict "Src" $image "Context" .Page "Alt" .Title "Class" "w-full rounded") }}
            </div>
          {{ end }}
          <h1 class="h2 mb-4">
            {{ .Title }}
          </h1>
          <ul class="mb-4">
            <li class="mr-4 inline-block">
              <a
                href="{{ `authors/` | relLangURL }}{{ .Params.Author | urlize }}/">
                <i class="fa-regular fa-circle-user mr-2"></i
                >{{ .Params.author }}
              </a>
            </li>
            {{ $categories:= .Params.categories }}
            {{ if $categories }}
              <li class="mr-4 inline-block">
                <i class="fa-regular fa-folder mr-2"></i>
                {{ range $i,$p:= $categories }}
                  <a
                    href="{{ `categories/` | relLangURL }}{{ . | urlize | lower }}/"
                    class=""
                    >{{ . | humanize }}{{ if ne $i (sub (len $categories) 1) }}
                      {{ "," }}
                    {{ end }}
                  </a>
                {{ end }}
              </li>
            {{ end }}
            <li class="mr-4 inline-block">
              <i class="fa-regular fa-clock mr-2"></i>
              {{ time.Format ":date_long" .PublishDate }}
            </li>
          </ul>
          <div class="content mb-10">
            <!-- {{ partial "toc.html" (dict "Class" "blog" "Collapsed" false "TableOfContents" .TableOfContents ) }} -->
            {{ .Content }}
            
            <!-- Publications Section -->
            {{ if .Params.publications }}
              <div class="mt-12">
                <h2 class="text-2xl font-semibold mb-6 text-gray-900 dark:text-gray-100">Related Publications</h2>
                <div class="space-y-6">
                  {{ range $i, $pub := .Params.publications }}
                    {{ $citeID := printf "cite-box-blog-%d" $i }}
                    {{ $isFirstAuthor := false }}
                    {{ with index $pub.authors 0 }}
                      {{ if hasPrefix . "**Xiucheng Liang**" }}
                        {{ $isFirstAuthor = true }}
                      {{ end }}
                    {{ end }}
                    
                    <div class="publication-item p-6 border border-gray-200 dark:border-gray-700 rounded-lg bg-white dark:bg-neutral-900 {{ if $isFirstAuthor }}first-author{{ end }}">
                      
                      <h3 class="text-xl font-semibold mb-2 text-gray-900 dark:text-gray-100 {{ if $isFirstAuthor }}text-primary{{ end }}">
                        {{ $pub.title }}
                      </h3>
                      
                      <p class="text-gray-700 dark:text-gray-300 mb-2">
                        {{ range $idx, $author := $pub.authors }}
                          {{ if $idx }}, {{ end }}{{ $author | markdownify }}
                        {{ end }}
                      </p>
                      
                      <p class="text-gray-500 dark:text-gray-400 mb-4">{{ $pub.paper_info }}</p>
                      
                      <!-- Action Buttons -->
                      <div class="flex flex-wrap gap-3 mb-4">
                        {{ with $pub.pdf_link }}
                          <a href="{{ . }}" class="btn btn-primary btn-sm" target="_blank" rel="noopener">PDF</a>
                        {{ end }}
                        {{ with $pub.doi_link }}
                          <a href="{{ . }}" class="btn btn-secondary btn-sm" target="_blank" rel="noopener">DOI</a>
                        {{ end }}
                        {{ with $pub.code_link }}
                          <a href="{{ . }}" class="btn btn-secondary btn-sm" target="_blank" rel="noopener">Code</a>
                        {{ end }}
                        {{ with $pub.bibtex }}
                          <button class="btn btn-secondary btn-sm" data-toggle-cite="{{ $citeID }}">BibTeX</button>
                        {{ end }}
                      </div>
                      
                      <!-- Citation Box -->
                      {{ with $pub.bibtex }}
                        <div id="{{ $citeID }}" class="citation-box hidden mt-4 p-4 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-600 rounded">
                          <pre class="text-sm overflow-auto text-gray-800 dark:text-gray-200"><code data-cite-text>{{ . | safeHTML }}</code></pre>
                          <div class="mt-3 flex gap-2">
                            <button class="btn btn-primary btn-xs" data-copy-cite>Copy</button>
                            <button class="btn btn-secondary btn-xs" data-download-cite>Download</button>
                          </div>
                        </div>
                      {{ end }}
                    </div>
                  {{ end }}
                </div>
              </div>
            {{ end }}
          </div>
          <div class="row items-start justify-between">
            {{ $tags:= .Params.tags }}
            {{ if $tags }}
              <div class="lg:col-6 mb-10 flex items-center lg:mb-0">
                <h5 class="mr-3">Tags :</h5>
                <ul>
                  {{ range $i,$p:= $tags }}
                    <li class="inline-block">
                      <a
                        class="bg-light hover:bg-primary dark:bg-darkmode-light dark:hover:bg-darkmode-primary dark:hover:text-text-dark m-1 block rounded px-3 py-1 hover:text-white"
                        href="{{ `tags/` | relLangURL }}{{ . | urlize | lower }}/">
                        {{ . | humanize }}
                      </a>
                    </li>
                  {{ end }}
                </ul>
              </div>
            {{ end }}
            <!-- <div class="lg:col-6 flex items-center lg:justify-end">
              <h5>{{ T "share" }} :</h5>
              {{ partial "social-share" (dict "Context" . "Class" "share-icons" "Title" .Title "Whatsapp" false "Telegram" false "Linkedin" false "Pinterest" false "Tumblr" false "Vk" false "Reddit" false) }}
            </div> -->
          </div>
        </article>
      </div>

      <!-- Related posts -->
      {{ $related := .Site.RegularPages.Related . | first 10 }}
      {{ $related = $related | shuffle | first 3 }}
      {{ with $related }}
        <div class="section pb-0">
          <h2 class="h3 mb-12">Related Posts</h2>
          <div class="row">
            {{ range . }}
              <div class="lg:col-4 md:col-6 mb-14">
                {{ partial "components/blog-card" . }}
              </div>
            {{ end }}
          </div>
        </div>
      {{ end }}
    </div>
  </section>

  <!-- Publications JavaScript -->
  {{ if .Params.publications }}
    <script>
    (function() {
      function getCiteText(btn) {
        const box = btn.closest('.publication-item').querySelector('.citation-box');
        const code = box && box.querySelector('code[data-cite-text]');
        return code ? code.textContent : '';
      }

      document.addEventListener('click', async (e) => {
        // Toggle cite box
        const toggle = e.target.closest('[data-toggle-cite]');
        if (toggle) {
          e.preventDefault();
          const box = document.getElementById(toggle.getAttribute('data-toggle-cite'));
          if (box) box.classList.toggle('hidden');
          return;
        }
        
        // Copy citation
        if (e.target.closest('[data-copy-cite]')) {
          const text = getCiteText(e.target).trim();
          try {
            await navigator.clipboard.writeText(text);
            e.target.textContent = 'Copied!';
            setTimeout(() => (e.target.textContent = 'Copy'), 1200);
          } catch (err) {
            console.error('Copy failed:', err);
          }
          return;
        }
        
        // Download citation
        if (e.target.closest('[data-download-cite]')) {
          const text = getCiteText(e.target).trim();
          const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'citation.bib';
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
          return;
        }
      });
    })();
    </script>

    <style>
    .btn-sm { 
      padding: 0.375rem 0.75rem; 
      font-size: 0.875rem; 
      line-height: 1.25rem;
    }
    .btn-xs { 
      padding: 0.25rem 0.5rem; 
      font-size: 0.75rem; 
      line-height: 1rem;
    }
    .first-author { 
      border-left: 4px solid #424242;
    }
    .dark .first-author {
      border-left: 4px solid #D6D6D6;
    }
    .publication-item:hover { 
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      transform: translateY(-1px);
      transition: all 0.2s ease-in-out;
    }
    .citation-box pre {
      max-height: 300px;
      overflow-y: auto;
    }
    </style>
  {{ end }}

  <!-- Global Image Width Control Styles -->
  <style>
  /* Image width control classes */
  .content img {
    max-width: 100%;
    height: auto;
    display: block;
    margin: 1rem auto;
    border-radius: 0.5rem;
  }
  
  /* Width control classes for img tags and Hugo shortcodes */
  .img-80, .img-80 img, .img-80 figure, .img-80 figure img {
    width: 80% !important;
    max-width: 80% !important;
  }
  
  .img-40, .img-40 img, .img-40 figure, .img-40 figure img {
    width: 40% !important;
    max-width: 40% !important;
  }
  
  .img-45, .img-45 img, .img-45 figure, .img-45 figure img {
    width: 45% !important;
    max-width: 45% !important;
  }
  
  .img-60, .img-60 img, .img-60 figure, .img-60 figure img {
    width: 60% !important;
    max-width: 60% !important;
  }
  
  .img-90, .img-90 img, .img-90 figure, .img-90 figure img {
    width: 90% !important;
    max-width: 90% !important;
  }
  
  .img-full, .img-full img, .img-full figure, .img-full figure img {
    width: 100% !important;
    max-width: 100% !important;
  }
  
  /* Support for wrapper divs around markdown images and shortcodes */
  .img-80 p, .img-45 p, .img-40 p, .img-60 p, .img-90 p, .img-full p,
  .img-80 figure, .img-45 figure, .img-40 figure, .img-60 figure, .img-90 figure, .img-full figure {
    text-align: center;
    margin: 1rem auto;
  }
  
  /* Hugo shortcode image styling */
  .content figure {
    margin: 1rem auto;
    text-align: center;
  }
  
  .content figure img {
    margin: 0 auto;
  }
  
  /* Side-by-side image layouts */
  .img-row {
    display: flex;
    gap: 1rem;
    justify-content: center;
    align-items: flex-start;
    flex-wrap: wrap;
    margin: 1.5rem 0;
  }
  
  .img-row figure {
    flex: 1;
    margin: 0;
  }
  
  /* Responsive adjustments */
  @media (max-width: 768px) {
    .img-80, .img-60, .img-45, .img-40 {
      width: 90% !important;
      max-width: 90% !important;
    }
  }
  
  @media (max-width: 480px) {
    .img-80, .img-60, .img-45, .img-40, .img-90 {
      width: 100% !important;
      max-width: 100% !important;
    }
  }
  </style>
{{ end }}
